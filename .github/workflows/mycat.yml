name: Deploy to GitHub Pages

# 触发条件：推送到 main 分支时执行
on:
  push:
    branches: [ main ]
  # 允许手动触发，方便你在 GitHub Actions 页面点 Run workflow 重试
  workflow_dispatch:

# 如果仓库默认 GITHUB_TOKEN 权限是只读，这里显式开启写权限，避免无法推送 gh-pages
permissions:
  contents: write

# 避免同一分支并发部署互相覆盖
concurrency:
  group: pages-${{ github.ref }}
  cancel-in-progress: true

# 执行任务
jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      # 1. 拉取仓库代码
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # 2. 安装 Node.js（适配项目的 Node 版本，比如 18）
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: 'npm'  # 缓存 npm 依赖，加速构建

      # 3. 安装依赖
      - name: Install dependencies
        run: npm ci

      # 4. 打包生成 dist（React 项目改命令为 npm run build）
      - name: Build project
        # GitHub Pages：
        # - 普通仓库：部署在 /<repo>/ 子路径下，不设置 base 会导致资源 404
        # - <user>.github.io 仓库：部署在根路径 /，base 应为 /
        shell: bash
        run: |
          REPO_NAME='${{ github.event.repository.name }}'
          if [[ "$REPO_NAME" == *.github.io ]]; then
            BASE="/"
          else
            BASE="/$REPO_NAME/"
          fi
          echo "Building with base: $BASE"
          npm run build -- --base="$BASE"

      # 5. 部署到 gh-pages 分支
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          # 部署 dist 目录（React 改填 build）
          publish_dir: ./dist
          # GitHub 自动生成的令牌，无需手动配置
          github_token: ${{ secrets.GITHUB_TOKEN }}
          # 部署到 gh-pages 分支
          publish_branch: gh-pages
          # 保持 gh-pages 分支干净（每次用全新提交覆盖）
          force_orphan: true
          # 禁用 Jekyll（避免某些静态文件被忽略/改写）
          enable_jekyll: false
